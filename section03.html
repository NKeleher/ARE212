<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Section 3: Functions and loops</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}

.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ARE 212</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Section notes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="notes.html">Table of Contents</a>
    </li>
    <li>
      <a href="section00.html">Section 0</a>
    </li>
    <li>
      <a href="section01.html">Section 1</a>
    </li>
    <li>
      <a href="section02.html">Section 2</a>
    </li>
    <li>
      <a href="section03.html">Section 3</a>
    </li>
    <li>
      <a href="latexKnitr.html">LaTeX and knitr</a>
    </li>
  </ul>
</li>
<li>
  <a href="courseInfo.html">Course Info</a>
</li>
<li>
  <a href="syllabi.html">Syllabi</a>
</li>
<li>
  <a href="resources.html">R Resources</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="contact.html">
    <span class="fa fa-envelope-o fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/edrubin/ARE212">
    <span class="fa fa-github-square fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://edrub.in">
    <span class="fa fa-hand-peace-o fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Section 3: Functions and loops</h1>

</div>


<p><br></p>
<div id="admin" class="section level1">
<h1>Admin</h1>
<p>Change in office hours <strong>this week</strong>: 10:30am–12pm in Giannini 236. (Apologies for the inconvenience; department-level scheduling issues…)</p>
<div id="what-you-will-need" class="section level2">
<h2>What you will need</h2>
<p><strong>Packages</strong>:</p>
<ul>
<li>Previously used: <code>dplyr</code> and <code>haven</code></li>
<li>New: <code>lfe</code></li>
</ul>
<p><strong>Data</strong>: The auto.dta file.</p>
</div>
<div id="summary-of-last-time" class="section level2">
<h2>Summary of last time</h2>
<p>In <a href="section02.html">Section 2</a>, we covered the data structures of vectors and matrices.</p>
<div id="follow-up-numeric-vs.double" class="section level3">
<h3>Follow up: Numeric vs. double</h3>
<p>Someone asked about <em>double</em> versus <em>numeric</em>. It turns out that <em>numeric</em> is a more general class/mode. <a href="http://faculty.nps.edu/sebuttre/home/R/data.html">Numeric objects come in different modes</a>. Specifically, numeric objects can be either double-precision or integer (single-precision is not really an option in R, unless you are calling C or Fortran at a lower level).</p>
<p>In practice:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Does as.numeric() create integers or doubles?</span>
<span class="kw">is.double</span>(<span class="kw">as.numeric</span>(<span class="dv">1</span>))
## [1] TRUE
<span class="kw">is.integer</span>(<span class="kw">as.numeric</span>(<span class="dv">1</span>))
## [1] FALSE
<span class="co"># Are integers and doubles numeric?</span>
<span class="kw">is.numeric</span>(<span class="kw">as.double</span>(<span class="dv">1</span>))
## [1] TRUE
<span class="kw">is.numeric</span>(<span class="kw">as.integer</span>(<span class="dv">1</span>))
## [1] TRUE</code></pre></div>
</div>
<div id="follow-up-vectorized-operations" class="section level3">
<h3>Follow up: Vectorized operations</h3>
<p>I want to point out that I probably did not give vectors a fair shake. While seemingly simple, R allows you to do a lot of things with vectors that might be much more difficult in other languages. Specifically, R allows you to apply (most) functions to vectors, rather than individual elements of a vector.</p>
<p>For an underwhelming example, if you want to square each number in a vector <code>vec</code> in R, you can simply write <code>vec^2</code>. The alternative that many languages use requires iterating through the vector and squaring the individual elements while simultaneously storing the results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define the vector</span>
vec &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">5</span>
<span class="co"># Square the elements of the vector</span>
vec2 &lt;-<span class="st"> </span>vec^<span class="dv">2</span>
<span class="co"># Look at the result</span>
vec2
## [1]  1  4  9 16 25</code></pre></div>
</div>
</div>
<div id="summary-of-this-section" class="section level2">
<h2>Summary of this section</h2>
<p>This section covers functions, loops, and some simulation. We will take what you have been covering in lecture—the ordinary least squares (OLS) estimator—and create our very own OLS function.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> Then we will play around with our OLS function.</p>
</div>
</div>
<div id="custom-functions" class="section level1">
<h1>Custom functions</h1>
<p>Up to this point, we have written some lines of R code that rely upon already-defined functions. We are now going to try writing our own function.</p>
<p>There are a few reasons why you want to write your own function:</p>
<ol style="list-style-type: decimal">
<li>Max forbids you from doing your homeworks with the canned functions.</li>
<li>You have a task for which there is not a function.</li>
<li>You have a task that needs to be repeated, and you do not want to keep writing the same <span class="math inline">\(N\)</span> lines of code over and over again.</li>
</ol>
<p>More simply: if you need to do the same task more than twice, you should probably write a function for that task, rather than copying and pasting the code dozens of times.</p>
<div id="custom-function-basics" class="section level2">
<h2>Custom function basics</h2>
<p>To write a custom function in R, you use a function named <code>function()</code>.<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> The specific syntax for defining a function looks like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">foo &lt;-<span class="st"> </span>function(arg1, arg2) {
  ...
  <span class="kw">return</span>(final_stuff)
}</code></pre></div>
<p>which says that we are defining a new function named <code>foo</code> that takes the arguments <code>arg1</code> and <code>arg2</code> (your function can take as many or as few arguments as you like). The function then completes some tasks (you would have actual code where you currently see <code>...</code>), and then the function returns a value of <code>final_stuff</code> using the <code>return()</code> function.<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> Notice that after you define the function’s arguments, you open a curly bracket and immediately start a new line. You end function’s definition by closing the curly bracket (on a line by itself).</p>
<p>For a quick example of a custom function, let’s define a function that accepts three arguments and returns the product of the three arguments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define the function (named &#39;triple_prod&#39;)</span>
triple_prod &lt;-<span class="st"> </span>function(x, y, z) {
  <span class="co"># Take the product of the three arguments</span>
  tmp_prod &lt;-<span class="st"> </span>x *<span class="st"> </span>y *<span class="st"> </span>z
  <span class="co"># Return &#39;tmp_prod&#39;</span>
  <span class="kw">return</span>(tmp_prod)
}

<span class="co"># Test the function</span>
<span class="kw">triple_prod</span>(<span class="dt">x =</span> <span class="dv">2</span>, <span class="dt">y =</span> <span class="dv">3</span>, <span class="dt">z =</span> <span class="dv">5</span>)
## [1] 30</code></pre></div>
</div>
<div id="an-ols-function" class="section level2">
<h2>An OLS function</h2>
<p>As discussed above, functions are very helpful when you have a task that you want to repeat many times. In this class,<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a> you will estimate <span class="math inline">\(\widehat{\boldsymbol{\beta}}_{ols}\)</span> <strong>many</strong> times. So let’s write a function that calculates the OLS estimator for <span class="math inline">\(\boldsymbol{\beta}\)</span>.</p>
<p>Recall that for an outcome (dependent) variable <span class="math inline">\(\mathbf{y}\)</span> and a matrix of independent variables <span class="math inline">\(\mathbf{X}\)</span> (including a column of ones for the intercept), the OLS estimator for <span class="math inline">\(\boldsymbol{\beta}\)</span> in the equation</p>
<p><span class="math display">\[ \mathbf{y} = \mathbf{X} \boldsymbol{\beta} + \boldsymbol{\varepsilon} \]</span></p>
<p>is</p>
<p><span class="math display">\[ \widehat{\boldsymbol{\beta}}_{ols} = \left(\mathbf{X}&#39;\mathbf{X}\right)^{-1}\mathbf{X}&#39;\mathbf{y} \]</span></p>
<p>Part of writing a function is determining what you want and do not want the function to do. You have a lot of options. Should it accept matrices, tibbles, data frames, <em>etc.</em>? Should the function automatically add a row for the interept? Should it calculate the R<sup>2</sup> or only <span class="math inline">\(\widehat{\boldsymbol{\beta}}_{ols}\)</span>? …</p>
<p>For now, let’s assume the function will accept a tibble with the variables that we want for both <span class="math inline">\(\mathbf{y}\)</span> and <span class="math inline">\(\mathbf{X}\)</span>. And let’s name the function <code>b_ols</code>. In addition to the tibble (let’s pass the tibble to the function through the argument <code>data</code>), the function will probably need (at least) two more arguments: <code>y</code> and <code>X</code>, which will be the name of the dependent variable and the names of the independent variables, respectively. Finally—for now—let’s say the function will only return the OLS estimate for <span class="math inline">\(\boldsymbol{\beta}\)</span>.</p>
<p>The function should thus look something like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_ols &lt;-<span class="st"> </span>function(data, y, X) {
  <span class="co"># Put some code here...</span>
  <span class="kw">return</span>(beta_hat)
}</code></pre></div>
<div id="aside-load-your-data" class="section level3">
<h3>Aside: Load your data</h3>
<p>Our OLS function will need some data. Load the auto.dta data from <a href="section01.html">Section 1</a> (also in this section’s zip file). (Remember: you will need the <code>haven</code> package to load the .dta file.) We’re not loading the data inside our function because we’ll probably want to use the function on different datasets.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Setup ----</span>
<span class="co"># Options</span>
<span class="kw">options</span>(<span class="dt">stringsAsFactors =</span> F)
<span class="co"># Packages</span>
<span class="kw">library</span>(haven)
<span class="kw">library</span>(dplyr)
<span class="co"># Set the directory</span>
<span class="kw">setwd</span>(<span class="st">&quot;/Users/edwardarubin/Dropbox/Teaching/ARE212/Section03/&quot;</span>)

<span class="co"># Load the data ----</span>
cars &lt;-<span class="st"> </span><span class="kw">read_dta</span>(<span class="dt">file =</span> <span class="st">&quot;auto.dta&quot;</span>)</code></pre></div>
</div>
<div id="required-packages" class="section level3">
<h3><code>require</code>d packages</h3>
<p><em>Spoiler:</em> Our function is going to make use of the <code>dplyr</code> package. So let’s tell our function to make sure the <code>dplyr</code> package is loaded. The function <code>require()</code> is the standard way to have a function make sure a package is loaded. You use it just like the <code>library()</code> function. Since we know that we plan to use the <code>dplyr</code> package, let’s require it within our function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_ols &lt;-<span class="st"> </span>function(data, y, X) {
  <span class="co"># Require the &#39;dplyr&#39; package</span>
  <span class="kw">require</span>(dplyr)
  <span class="co"># Put some code here...</span>
  <span class="kw">return</span>(beta_hat)
}</code></pre></div>
</div>
<div id="select_ing-variables" class="section level3">
<h3><code>select_</code>ing variables</h3>
<p>Let’s take an inventory of which objects we have, once we are inside the function. We have <code>data</code>, which is a tibble with columns that represent various variables. We have <code>y</code>, the name of our outcome variable (<em>e.g.</em>, <code>weight</code>). And we have <code>X</code>, a vector of the names of our independent variables (<em>e.g.</em> <code>c(&quot;mpg&quot;, &quot;weight&quot;)</code>).<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a></p>
<p>The first step for our function is to grab the data for <code>y</code> and <code>X</code> from <code>data</code>. For this task, we will use a variation of the <code>select()</code> function introduced in <a href="section01.html">Section 1</a>: <code>select_()</code>. The difference between <code>select()</code> and <code>select_()</code> (besides the underscore) is that <code>select()</code> wants the variable names without quotes (<em>non-standard evaluation</em>), <em>e.g.</em> <code>select(cars, mpg, weight)</code>. This notation is pretty convenient except when you are writing your own function. Generally, you will have variable/column names in a character vector, and <code>select(cars, &quot;mpg&quot;, &quot;weight&quot;)</code> does not work. Here is where <code>select_()</code> comes in: it <em>wants</em> you to use characters (<em>standard evaluation</em>). There is one more complexity: while <code>select_(cars, &quot;mpg&quot;, &quot;weight&quot;)</code> works, <code>select_(cars, c(&quot;mpg&quot;, &quot;weight&quot;))</code> does not. So if you have a vector of variable names, like our <code>X</code>, you need a slightly different way to use <code>select_()</code>. The solution is the <code>.dots</code> argument in <code>select_()</code>: <code>select_(cars, .dots = c(&quot;mpg&quot;, &quot;weight&quot;))</code> works!</p>
<p>So… we now want to select the <code>y</code> and <code>X</code> variables from <code>data</code>. Let’s do it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select y variable data from &#39;data&#39;</span>
y_data &lt;-<span class="st"> </span><span class="kw">select_</span>(data, <span class="dt">.dots =</span> y)
<span class="co"># Select X variable data from &#39;data&#39;</span>
X_data &lt;-<span class="st"> </span><span class="kw">select_</span>(data, <span class="dt">.dots =</span> X)</code></pre></div>
<p>This code should do the trick. To test it, you’ll need to define <code>y</code> and <code>X</code> (<em>e.g.</em>, <code>y = &quot;price&quot;</code> and <code>X = c(&quot;mpg&quot;, &quot;weight&quot;)</code>).</p>
</div>
<div id="exercise-finish-the-function" class="section level3">
<h3>Exercise: Finish the function</h3>
<p>The function now looks like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_ols &lt;-<span class="st"> </span>function(data, y, X) {
  <span class="co"># Require the &#39;dplyr&#39; package</span>
  <span class="kw">require</span>(dplyr)
  <span class="co"># Select y variable data from &#39;data&#39;</span>
  y_data &lt;-<span class="st"> </span><span class="kw">select_</span>(data, <span class="dt">.dots =</span> y)
  <span class="co"># Select X variable data from &#39;data&#39;</span>
  X_data &lt;-<span class="st"> </span><span class="kw">select_</span>(data, <span class="dt">.dots =</span> X)
  <span class="co"># Put some code here...</span>
  <span class="kw">return</span>(beta_hat)
}</code></pre></div>
<p>Fill in the <code># Put some code here...</code> section of our new function with the code needed to produce OLS estimates via matrix operations. More kudos for fewer lines.</p>
<div id="hintsreminders" class="section level4">
<h4>Hints/reminders:</h4>
<ul>
<li>The data objects <code>y_data</code> and <code>X_data</code> are still tibbles. You eventually want matrices.</li>
<li>Don’t forget the intercept.</li>
<li>If you finish early, adapt the function to return centered R<sup>2</sup>, uncentered R<sup>2</sup>, and adjusted R<sup>2</sup>.</li>
</ul>
</div>
</div>
<div id="matrices" class="section level3">
<h3>Matrices</h3>
<p>We have a few tasks left:</p>
<ol style="list-style-type: decimal">
<li>Add an intercept (column of ones) to <code>X_data</code></li>
<li>Convert the data objects to matrices</li>
<li>Calculate <span class="math inline">\(\widehat{\boldsymbol{\beta}}_{ols}\)</span> via matrix operations</li>
</ol>
<p>First, let’s add a column of ones to <code>X_data</code>. We will use <code>mutate_()</code>.<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a> The <code>mutate()</code> and <code>mutate_()</code> functions allow us to add new columns/variables to an existing data object. Often the new variables will be a combination of existing variables, but in our case, we just want a column of ones, so all we need to do is write <code>mutate(X_data, &quot;ones&quot; = 1)</code>.</p>
<p>It is customary to have the intercept column be the first column in the matrix. We can use <code>select_()</code> again to change the order of the columns: <code>select_(X_data, &quot;ones&quot;, .dots = X)</code>.</p>
<p>We will use the <code>as.matrix()</code> function to convert our tibbles to matrices.</p>
<p>Finally, once we have our matrices, we can use the basic matrix functions discussed in <a href="section02.html">Section 2</a>—namely <code>%*%</code>, <code>t()</code>, and <code>solve()</code>—to calculate <span class="math inline">\(\widehat{\boldsymbol{\beta}}_{ols} = \left(\mathbf{X}&#39;\mathbf{X}\right)^{-1}\mathbf{X}&#39;\mathbf{y}\)</span>.</p>
<p>Putting these steps together, we can finish our function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_ols &lt;-<span class="st"> </span>function(data, y, X) {
  <span class="co"># Require the &#39;dplyr&#39; package</span>
  <span class="kw">require</span>(dplyr)

  <span class="co"># Select y variable data from &#39;data&#39;</span>
  y_data &lt;-<span class="st"> </span><span class="kw">select_</span>(data, <span class="dt">.dots =</span> y)
  <span class="co"># Convert y_data to matrices</span>
  y_data &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(y_data)

  <span class="co"># Select X variable data from &#39;data&#39;</span>
  X_data &lt;-<span class="st"> </span><span class="kw">select_</span>(data, <span class="dt">.dots =</span> X)
  <span class="co"># Add a column of ones to X_data</span>
  X_data &lt;-<span class="st"> </span><span class="kw">mutate_</span>(X_data, <span class="st">&quot;ones&quot;</span> =<span class="st"> </span><span class="dv">1</span>)
  <span class="co"># Move the intercept column to the front</span>
  X_data &lt;-<span class="st"> </span><span class="kw">select_</span>(X_data, <span class="st">&quot;ones&quot;</span>, <span class="dt">.dots =</span> X)
  <span class="co"># Convert X_data to matrices</span>
  X_data &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(X_data)

  <span class="co"># Calculate beta hat</span>
  beta_hat &lt;-<span class="st"> </span><span class="kw">solve</span>(<span class="kw">t</span>(X_data) %*%<span class="st"> </span>X_data) %*%<span class="st"> </span><span class="kw">t</span>(X_data) %*%<span class="st"> </span>y_data
  <span class="co"># Change the name of &#39;ones&#39; to &#39;intercept&#39;</span>
  <span class="kw">rownames</span>(beta_hat) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;intercept&quot;</span>, X)
  <span class="co"># Return beta_hat</span>
  <span class="kw">return</span>(beta_hat)
}</code></pre></div>
</div>
</div>
<div id="piping" class="section level2">
<h2>Piping</h2>
<p>Our OLS function is nice, but we redefined <code>y_data</code> and <code>X_data</code> a number of times. There’s nothing wrong with these intermediate steps, but <code>dplyr</code> provides a fantastic tool <code>%&gt;%</code> for bypassing these steps to clean up your code. The operator is known as the pipe or chain command.<a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a></p>
<p>The way the pipe (<code>%&gt;%</code>) works is by taking the output from one expression and plugging it into the next expression (defaulting to the first argument in the second expression). For example, rather than writing the two lines of code</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Select the variables</span>
tmp_data &lt;-<span class="st"> </span><span class="kw">select</span>(cars, price, mpg, weight)
<span class="co"># Summarize the selected variables</span>
<span class="kw">summary</span>(tmp_data)
##      price            mpg            weight    
##  Min.   : 3291   Min.   :12.00   Min.   :1760  
##  1st Qu.: 4220   1st Qu.:18.00   1st Qu.:2250  
##  Median : 5006   Median :20.00   Median :3190  
##  Mean   : 6165   Mean   :21.30   Mean   :3019  
##  3rd Qu.: 6332   3rd Qu.:24.75   3rd Qu.:3600  
##  Max.   :15906   Max.   :41.00   Max.   :4840</code></pre></div>
<p>we can do it in a single line (and without creating the unnecessary object <code>tmp_data</code>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cars %&gt;%<span class="st"> </span><span class="kw">select</span>(price, mpg, weight) %&gt;%<span class="st"> </span><span class="kw">summary</span>()
##      price            mpg            weight    
##  Min.   : 3291   Min.   :12.00   Min.   :1760  
##  1st Qu.: 4220   1st Qu.:18.00   1st Qu.:2250  
##  Median : 5006   Median :20.00   Median :3190  
##  Mean   : 6165   Mean   :21.30   Mean   :3019  
##  3rd Qu.: 6332   3rd Qu.:24.75   3rd Qu.:3600  
##  Max.   :15906   Max.   :41.00   Max.   :4840</code></pre></div>
<p>What is going on here? We’re plugging <code>cars</code> into the first argument of the <code>select()</code> expression, and then plugging the output from <code>select()</code> into <code>summary()</code>. If you want to save the result from the <strong>last</strong> expression (<code>summary()</code> here), use the normal method, <em>e.g.</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">some_summaries &lt;-<span class="st"> </span>cars %&gt;%<span class="st"> </span><span class="kw">select</span>(price, mpg, weight) %&gt;%<span class="st"> </span><span class="kw">summary</span>()</code></pre></div>
<p>If it helps you remember what a pipe is doing, you can use a period with a comma:<a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Four equivalent expressions</span>
cars %&gt;%<span class="st"> </span><span class="kw">select</span>(price, mpg) %&gt;%<span class="st"> </span><span class="kw">summary</span>()
cars %&gt;%<span class="st"> </span><span class="kw">select</span>(., price, mpg) %&gt;%<span class="st"> </span><span class="kw">summary</span>()
<span class="kw">select</span>(cars, price, mpg) %&gt;%<span class="st"> </span><span class="kw">summary</span>()
<span class="kw">summary</span>(<span class="kw">select</span>(cars, price, mpg))</code></pre></div>
<p>You can see that pipes also help you avoid situations with crazy parentheses.</p>
<p>Now let’s apply these pipes to the OLS function above. Essentially any time you redefine an object, you could have used a pipe. Also note that pipes can extend to the next line and are uninterrupted by comments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">b_ols &lt;-<span class="st"> </span>function(data, y, X) {
  <span class="co"># Require the &#39;dplyr&#39; package</span>
  <span class="kw">require</span>(dplyr)

  <span class="co"># Create the y matrix</span>
  y_data &lt;-<span class="st"> </span>data %&gt;%
<span class="st">    </span><span class="co"># Select y variable data from &#39;data&#39;</span>
<span class="st">    </span><span class="kw">select_</span>(<span class="dt">.dots =</span> y) %&gt;%
<span class="st">    </span><span class="co"># Convert y_data to matrices</span>
<span class="st">    </span><span class="kw">as.matrix</span>()

  <span class="co"># Create the X matrix</span>
  X_data &lt;-<span class="st"> </span>data %&gt;%
<span class="st">    </span><span class="co"># Select X variable data from &#39;data&#39;</span>
<span class="st">    </span><span class="kw">select_</span>(<span class="dt">.dots =</span> X) %&gt;%
<span class="st">    </span><span class="co"># Add a column of ones to X_data</span>
<span class="st">    </span><span class="kw">mutate_</span>(<span class="st">&quot;ones&quot;</span> =<span class="st"> </span><span class="dv">1</span>) %&gt;%
<span class="st">    </span><span class="co"># Move the intercept column to the front</span>
<span class="st">    </span><span class="kw">select_</span>(<span class="st">&quot;ones&quot;</span>, <span class="dt">.dots =</span> X) %&gt;%
<span class="st">    </span><span class="co"># Convert X_data to matrices</span>
<span class="st">    </span><span class="kw">as.matrix</span>()

  <span class="co"># Calculate beta hat</span>
  beta_hat &lt;-<span class="st"> </span><span class="kw">solve</span>(<span class="kw">t</span>(X_data) %*%<span class="st"> </span>X_data) %*%<span class="st"> </span><span class="kw">t</span>(X_data) %*%<span class="st"> </span>y_data
  <span class="co"># Change the name of &#39;ones&#39; to &#39;intercept&#39;</span>
  <span class="kw">rownames</span>(beta_hat) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;intercept&quot;</span>, X)
  <span class="co"># Return beta_hat</span>
  <span class="kw">return</span>(beta_hat)
}</code></pre></div>
</div>
<div id="quality-check" class="section level2">
<h2>Quality check</h2>
<p>Let’s check our function’s results against one of R’s canned regression functions. The base installation of R provides the function <code>lm()</code>, which works great. However, we are going to use the <code>felm()</code> function from the <code>lfe</code> package. The <code>felm()</code> function has some nice benefits over <code>lm()</code> that you will probably want at some point, namely the ability to deal with <em>many</em> fixed effects, instrumental variables, and multi-way clustered errors. (Don’t worry if you do not know what that last sentence meant. You will soon.)</p>
<p>Install the <code>lfe</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&quot;lfe&quot;</span>)</code></pre></div>
<p>Load it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lfe)</code></pre></div>
<p>Run the relevant regression with <code>felm()</code>:<a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Run the regression with &#39;felm&#39;</span>
canned_ols &lt;-<span class="st"> </span><span class="kw">felm</span>(<span class="dt">formula =</span> price ~<span class="st"> </span>mpg +<span class="st"> </span>weight, <span class="dt">data =</span> cars)
<span class="co"># Summary of the regression</span>
canned_ols %&gt;%<span class="st"> </span><span class="kw">summary</span>()
## 
## Call:
##    felm(formula = price ~ mpg + weight, data = cars) 
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -3332  -1858   -504   1256   7507 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept) 1946.0687  3597.0496   0.541  0.59019   
## mpg          -49.5122    86.1560  -0.575  0.56732   
## weight         1.7466     0.6414   2.723  0.00813 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 2514 on 71 degrees of freedom
## Multiple R-squared(full model): 0.2934   Adjusted R-squared: 0.2735 
## Multiple R-squared(proj model): 0.2934   Adjusted R-squared: 0.2735 
## F-statistic(full model):14.74 on 2 and 71 DF, p-value: 4.425e-06 
## F-statistic(proj model): 14.74 on 2 and 71 DF, p-value: 4.425e-06</code></pre></div>
<p>Run the regression with our function <code>b_ols()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">b_ols</span>(<span class="dt">data =</span> cars, <span class="dt">y =</span> <span class="st">&quot;price&quot;</span>, <span class="dt">X =</span> <span class="kw">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;weight&quot;</span>))
##                 price
## intercept 1946.068668
## mpg        -49.512221
## weight       1.746559</code></pre></div>
<p>They match!</p>
</div>
</div>
<div id="loops" class="section level1">
<h1>Loops</h1>
<p>Loops are a very common programming tool. Just like functions, loops help us with repetitive tasks.</p>
<div id="for-loops" class="section level2">
<h2><code>for()</code> loops</h2>
<p><code>for</code> loops are classic. You give the program a list and then tell it to do something with each of the objects in the list. R’s power with vectors obviates some uses of <code>for</code> loops, but there are still many cases in which you will need some type of loop. You will also hear people say that <code>for</code> loops are a bad idea in R. Don’t entirely believe them. There are cases where you can do things much faster with other types of loops—particularly if you are going to parallelize and have access to a lot of computing resources—but <code>for</code> loops can still be very helpful.</p>
<p>In R, the <code>for</code> loop has the following structure</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">for (i in vec) {
  <span class="co"># Complex computations go here</span>
}</code></pre></div>
<p>Example of an actual (simple) <code>for</code> loop:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">for (i in <span class="dv">1</span>:<span class="dv">5</span>) {
  <span class="kw">print</span>(<span class="kw">paste</span>(<span class="st">&quot;Hi&quot;</span>, i))
}</code></pre></div>
<pre><code>## [1] &quot;Hi 1&quot;
## [1] &quot;Hi 2&quot;
## [1] &quot;Hi 3&quot;
## [1] &quot;Hi 4&quot;
## [1] &quot;Hi 5&quot;</code></pre>
<p>A final note on <code>for</code> loops in R: R keeps the last iteration’s values in memory. This behavior can help with troubleshooting, but it can also sometimes lead to confusion.</p>
<p>While <code>for</code> loops are great, we’re going to focus on a different type of loop today…</p>
</div>
<div id="lapply" class="section level2">
<h2><code>lapply()</code></h2>
<p>The <code>lapply()</code> function is part of a family of <code>apply()</code> functions in R (<code>apply()</code>, <code>lapply()</code>, <code>sapply()</code>, <code>mapply()</code>, <em>etc.</em>). Each function takes slightly different inputs and/or generates slightly different outputs, but the idea is generally the same. And the idea if very similar to that of a loop: you give <code>lapply()</code> a list or vector <code>X</code> and a function <code>FUN</code>, and <code>lapply()</code> with then apply the function <code>FUN</code> to each of the elements in <code>X</code>. <code>lapply()</code> returns a <em>list</em><a href="#fn10" class="footnoteRef" id="fnref10"><sup>10</sup></a> of the results generated by <code>FUN</code> for each of the elements of <code>X</code>.</p>
<p>Finally, it is worth noting that <code>lapply()</code> sticks the elements of <code>X</code> into the first argument of the function <code>FUN</code> (you can still define other arguments of <code>FUN</code>) in a way very similar to the pipe operator (<code>%&gt;%</code>).</p>
<p>Here is a simplistic example of <code>lapply()</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">lapply</span>(<span class="dt">X =</span> <span class="dv">0</span>:<span class="dv">4</span>, <span class="dt">FUN =</span> sqrt)</code></pre></div>
<pre><code>## [[1]]
## [1] 0
## 
## [[2]]
## [1] 1
## 
## [[3]]
## [1] 1.414214
## 
## [[4]]
## [1] 1.732051
## 
## [[5]]
## [1] 2</code></pre>
<p>Notice the slightly different notation of the list, relative to the vectors we previously discussed.</p>
<p>Unlike <code>for</code> loops, nothing done inside of an <code>lapply()</code> call is kept in memory after the function finishes (aside from the final results, if you assign them to an object).</p>
<div id="lapply-meets-b_ols" class="section level3">
<h3><code>lapply()</code> meets <code>b_ols()</code></h3>
<p>What if we want to regress each of the numerical variables in the <code>cars</code> data on <code>mpg</code> and <code>weight</code> (with the exception of <code>rep78</code>, because I don’t really understand what “Repair Record 1978” means)? Surprise, surprise: we can use <code>lapply()</code>.</p>
<p>What should our <code>X</code> value be? The numeric variables excluding <code>rep78</code>, <code>mpg</code>, and <code>weight</code>. Let’s create a vector for it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">target_vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;price&quot;</span>, <span class="st">&quot;headroom&quot;</span>, <span class="st">&quot;trunk&quot;</span>, <span class="st">&quot;length&quot;</span>, <span class="st">&quot;turn&quot;</span>,
  <span class="st">&quot;displacement&quot;</span>, <span class="st">&quot;gear_ratio&quot;</span>, <span class="st">&quot;foreign&quot;</span>)</code></pre></div>
<p>With respect to the <code>FUN</code> argument, keep in mind that <code>lapply()</code> plugs the <code>X</code> values into the first argument of the function. For <code>b_ols()</code>, the first argument is <code>data</code>, which is not what we currently want to vary. We want to vary <code>y</code>, which is the second argument. Rather than redefining the <code>b_ols()</code> function, we can augment it by wrapping another function around it. For example,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">function(i) <span class="kw">b_ols</span>(<span class="dt">data =</span> cars, <span class="dt">y =</span> i, <span class="dt">X =</span> <span class="kw">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;weight&quot;</span>))</code></pre></div>
<p>This line of code creates a new, unnamed function with one argument <code>i</code>. The argument <code>i</code> is then fed to our <code>b_ols()</code> function as its <code>y</code> argument. Let’s put it all together…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The &#39;lapply&#39; call</span>
results_list &lt;-<span class="st"> </span><span class="kw">lapply</span>(
  <span class="dt">X =</span> target_vars,
  <span class="dt">FUN =</span> function(i) <span class="kw">b_ols</span>(<span class="dt">data =</span> cars, <span class="dt">y =</span> i, <span class="dt">X =</span> <span class="kw">c</span>(<span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;weight&quot;</span>))
  )
<span class="co"># The results</span>
results_list</code></pre></div>
<pre><code>## [[1]]
##                 price
## intercept 1946.068668
## mpg        -49.512221
## weight       1.746559
## 
## [[2]]
##                headroom
## intercept  1.7943225731
## mpg       -0.0098904309
## weight     0.0004668253
## 
## [[3]]
##                  trunk
## intercept  5.849262628
## mpg       -0.082739270
## weight     0.003202433
## 
## [[4]]
##                 length
## intercept 120.11619444
## mpg        -0.35546594
## weight      0.02496695
## 
## [[5]]
##                   turn
## intercept 27.323996368
## mpg       -0.059092537
## weight     0.004498541
## 
## [[6]]
##           displacement
## intercept -151.9910285
## mpg          0.7604918
## weight       0.1103151
## 
## [[7]]
##              gear_ratio
## intercept  4.3311476331
## mpg        0.0007521123
## weight    -0.0004412382
## 
## [[8]]
##                 foreign
## intercept  2.1235056112
## mpg       -0.0194295266
## weight    -0.0004677698</code></pre>
<p>These results are a bit of a mess. Let’s change the list into a more legible data structure. We will use <code>lapply()</code> to apply the function <code>data.frame()</code> to each of the results (each of the elements of <code>results_list</code>). Finally, we will use the <code>bind_cols()</code> function from <code>dplyr</code> to bind all of the results together (so we don’t end up with another list).<a href="#fn11" class="footnoteRef" id="fnref11"><sup>11</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Cleaning up the results list</span>
results_df &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="dt">X =</span> results_list, <span class="dt">FUN =</span> data.frame) %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>()
<span class="co"># We lose the row names in the process; add them back</span>
<span class="kw">rownames</span>(results_df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;intercept&quot;</span>, <span class="st">&quot;mpg&quot;</span>, <span class="st">&quot;weight&quot;</span>)
<span class="co"># Check out results_df</span>
results_df</code></pre></div>
<pre><code>##                 price      headroom        trunk       length         turn
## intercept 1946.068668  1.7943225731  5.849262628 120.11619444 27.323996368
## mpg        -49.512221 -0.0098904309 -0.082739270  -0.35546594 -0.059092537
## weight       1.746559  0.0004668253  0.003202433   0.02496695  0.004498541
##           displacement    gear_ratio       foreign
## intercept -151.9910285  4.3311476331  2.1235056112
## mpg          0.7604918  0.0007521123 -0.0194295266
## weight       0.1103151 -0.0004412382 -0.0004677698</code></pre>
</div>
<div id="exercise-check-your-work" class="section level3">
<h3>Exercise: Check your work</h3>
<p>Check the results in <code>results_df</code> using <code>lapply()</code> and <code>felm()</code>. <em>Hint</em>: remember to check the class of the object returned <code>felm()</code>. You might want to try the <code>coef()</code> function on the object returned by <code>felm()</code>.</p>
</div>
</div>
</div>
<div id="simulation" class="section level1">
<h1>Simulation</h1>
<p>One of the main reasons to learn the <code>apply()</code> family of functions is that they are very flexible (and easily parallelized).<a href="#fn12" class="footnoteRef" id="fnref12"><sup>12</sup></a> This flexibility lends them to use in simulation, which basically means we want to generate random numbers and to test/observe properties of estimators. And repeat many times.</p>
<div id="examining-bias-in-one-sample" class="section level2">
<h2>Examining bias in one sample</h2>
<p>We often examine the (finite-sample) properties of estimators through simulation.</p>
<p>Let’s start with a function that generates some data, estimates coefficients via OLS, and calculates the bias.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A function to calculate bias</span>
data_baker &lt;-<span class="st"> </span>function(sample_n, true_beta) {
  <span class="co"># First generate x from N(0,1)</span>
  x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(sample_n)
  <span class="co"># Now the error from N(0,1)</span>
  e &lt;-<span class="st"> </span><span class="kw">rnorm</span>(sample_n)
  <span class="co"># Now combine true_beta, x, and e to get y</span>
  y &lt;-<span class="st"> </span>true_beta[<span class="dv">1</span>] +<span class="st"> </span>true_beta[<span class="dv">2</span>] *<span class="st"> </span>x +<span class="st"> </span>e
  <span class="co"># Define the data matrix of independent vars.</span>
  X &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, x)
  <span class="co"># Force y to be a matrix</span>
  y &lt;-<span class="st"> </span><span class="kw">matrix</span>(y, <span class="dt">ncol =</span> <span class="dv">1</span>)
  <span class="co"># Calculate the OLS estimates</span>
  b_ols &lt;-<span class="st"> </span><span class="kw">solve</span>(<span class="kw">t</span>(X) %*%<span class="st"> </span>X) %*%<span class="st"> </span><span class="kw">t</span>(X) %*%<span class="st"> </span>y
  <span class="co"># Convert b_ols to vector</span>
  b_ols &lt;-<span class="st"> </span>b_ols %&gt;%<span class="st"> </span><span class="kw">as.vector</span>()
  <span class="co"># Calculate bias, force to 2x1 data.frame()</span>
  the_bias &lt;-<span class="st"> </span>(true_beta -<span class="st"> </span>b_ols) %&gt;%
<span class="st">    </span><span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="dv">2</span>) %&gt;%<span class="st"> </span><span class="kw">data.frame</span>()
  <span class="co"># Set names</span>
  <span class="kw">names</span>(the_bias) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;bias_intercept&quot;</span>, <span class="st">&quot;bias_x&quot;</span>)
  <span class="co"># Return the bias</span>
  <span class="kw">return</span>(the_bias)
}</code></pre></div>
<p>This function will calculate the bias of the OLS estimator for a single sample,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Set seed</span>
<span class="kw">set.seed</span>(<span class="dv">12345</span>)
<span class="co"># Run once</span>
<span class="kw">data_baker</span>(<span class="dt">sample_n =</span> <span class="dv">100</span>, <span class="dt">true_beta =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>))</code></pre></div>
<pre><code>##   bias_intercept      bias_x
## 1    -0.02205339 -0.09453503</code></pre>
</div>
<div id="examining-bias-in-many-samples" class="section level2">
<h2>Examining bias in many samples</h2>
<p>But what if you want to run 10,000 simulations? Should you just copy and paste 10,000 times? Probably not.<a href="#fn13" class="footnoteRef" id="fnref13"><sup>13</sup></a> Use <code>lapply()</code> (or <code>replicate()</code>). And let’s write one more function wrapped around <code>data_baker()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># A function to run the simulation</span>
bias_simulator &lt;-<span class="st"> </span>function(n_sims, sample_n, true_beta) {

  <span class="co"># A function to calculate bias</span>
  data_baker &lt;-<span class="st"> </span>function(sample_n, true_beta) {
    <span class="co"># First generate x from N(0,1)</span>
    x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(sample_n)
    <span class="co"># Now the error from N(0,1)</span>
    e &lt;-<span class="st"> </span><span class="kw">rnorm</span>(sample_n)
    <span class="co"># Now combine true_beta, x, and e to get y</span>
    y &lt;-<span class="st"> </span>true_beta[<span class="dv">1</span>] +<span class="st"> </span>true_beta[<span class="dv">2</span>] *<span class="st"> </span>x +<span class="st"> </span>e
    <span class="co"># Define the data matrix of independent vars.</span>
    X &lt;-<span class="st"> </span><span class="kw">cbind</span>(<span class="dv">1</span>, x)
    <span class="co"># Force y to be a matrix</span>
    y &lt;-<span class="st"> </span><span class="kw">matrix</span>(y, <span class="dt">ncol =</span> <span class="dv">1</span>)
    <span class="co"># Calculate the OLS estimates</span>
    b_ols &lt;-<span class="st"> </span><span class="kw">solve</span>(<span class="kw">t</span>(X) %*%<span class="st"> </span>X) %*%<span class="st"> </span><span class="kw">t</span>(X) %*%<span class="st"> </span>y
    <span class="co"># Convert b_ols to vector</span>
    b_ols &lt;-<span class="st"> </span>b_ols %&gt;%<span class="st"> </span><span class="kw">as.vector</span>()
    <span class="co"># Calculate bias, force to 2x1 data.frame()</span>
    the_bias &lt;-<span class="st"> </span>(true_beta -<span class="st"> </span>b_ols) %&gt;%
<span class="st">      </span><span class="kw">matrix</span>(<span class="dt">ncol =</span> <span class="dv">2</span>) %&gt;%<span class="st"> </span><span class="kw">data.frame</span>()
    <span class="co"># Set names</span>
    <span class="kw">names</span>(the_bias) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;bias_intercept&quot;</span>, <span class="st">&quot;bias_x&quot;</span>)
    <span class="co"># Return the bias</span>
    <span class="kw">return</span>(the_bias)
  }

  <span class="co"># Run data_baker() n_sims times with given parameters</span>
  sims_dt &lt;-<span class="st"> </span><span class="kw">lapply</span>(
    <span class="dt">X =</span> <span class="dv">1</span>:n_sims,
    <span class="dt">FUN =</span> function(i) <span class="kw">data_baker</span>(sample_n, true_beta)) %&gt;%
<span class="st">    </span><span class="co"># Bind the rows together to output a nice data.frame</span>
<span class="st">    </span><span class="kw">bind_rows</span>()

  <span class="co"># Return sim_dt</span>
  <span class="kw">return</span>(sims_dt)
}</code></pre></div>
<p>To run the simulation 10,000 times, use the code (can take a little while):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Set seed</span>
<span class="kw">set.seed</span>(<span class="dv">12345</span>)
<span class="co"># Run it</span>
sim_dt &lt;-<span class="st"> </span><span class="kw">bias_simulator</span>(<span class="dt">n_sims =</span> <span class="fl">1e4</span>, <span class="dt">sample_n =</span> <span class="dv">100</span>, <span class="dt">true_beta =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>))
<span class="co"># Check the results with a histogram</span>
<span class="kw">hist</span>(sim_dt[,<span class="dv">2</span>],
  <span class="dt">breaks =</span> <span class="dv">30</span>,
  <span class="dt">main =</span> <span class="st">&quot;Is OLS unbiased?&quot;</span>,
  <span class="dt">xlab =</span> <span class="st">&quot;Bias&quot;</span>)
<span class="co"># Emphasize the zero line</span>
<span class="kw">abline</span>(<span class="dt">v =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">lwd =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="section03_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>
<p>Next section we’ll talk a bit about parallelization, which can greatly reduce the time of your simulations.</p>
</div>
</div>
<div id="extensionschallenges" class="section level1">
<h1>Extensions/challenges</h1>
<ol style="list-style-type: decimal">
<li>How few characters can you use to write a function that estimates coefficients via OLS? Can you keep this function parsimonious while expanding its flexibility (allowing it to take different data structures with and without intercepts)?</li>
<li>Can you find any speed/efficiency improvements over my <code>data_baker()</code> and <code>bias_simulator()</code> functions? Feel free to include parallelization.</li>
<li>How would you generate vectors of two random variables that are correlated (<em>i.e.</em> <span class="math inline">\(x\)</span> and <span class="math inline">\(\varepsilon\)</span> are not independent)? Does this correlation affect anything in your bias simulations?</li>
</ol>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Max has probably mentioned that you have to write your own functions in this class. While relying upon the canned R functions is prohibited, you can use them to check your work.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>So meta, right?<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>You can get away with not using the <code>return()</code> function, but it is generally thought of as bad form.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>not to mention the life of an empirical economist<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>I guess I’ve asserted these definitions of <code>y</code> and <code>X</code>. You’re free to do whatever you like.<a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>You could use <code>mutate()</code> too.<a href="#fnref6">↩</a></p></li>
<li id="fn7"><p>See the package <code>magrittr</code> for even more pipe operators.<a href="#fnref7">↩</a></p></li>
<li id="fn8"><p>Note: the period will actually allow you to shift the argument to which the prior expression’s output is sent.<a href="#fnref8">↩</a></p></li>
<li id="fn9"><p><code>felm()</code>, like most regression functions I’ve seen in R, uses a formula where the dependent variable<a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a> is separated from the independent variables with a tilde (<code>~</code>).<a href="#fnref9">↩</a></p></li>
<li id="fn10"><p>This is our first time meeting a list. Lists are yet another way to store data in R—like vectors, matrices, data.frames, and tibbles. You can create lists with the <code>list()</code> function much like you create vectors with the <code>c()</code> function: <code>my_list &lt;- list(&quot;a&quot;, 1, c(1,2,3))</code>. Lists differ in that they do not require a uniform data type, as demonstrated in the list in the preceding sentence. Lists also utilize a slightly different indexing: you access the third element of the list <code>my_list</code> via <code>my_list[[3]]</code>. Notice the extra set of square brackets.<a href="#fnref10">↩</a></p></li>
<li id="fn11"><p>We could alternatively try <code>sapply()</code>, which attempts to return nicely formatted objects. However, you never know if it is going to succeed in nicely formatting your results. If it doesn’t, then it returns a list. This sort of inconsistency is not very helpful in programming, so I generally avoid <code>sapply()</code>.<a href="#fnref11">↩</a></p></li>
<li id="fn12"><p>Parallelization basically means that you run things at the same time—instead of waiting until one thing finishes to start the next. Thus some tasks can be parallelized—simulations for unbiased estimators—while other tasks that depend upon the output from previous iterations are more difficult to parallelize. We’ll talk more about parallelization next time.<a href="#fnref12">↩</a></p></li>
<li id="fn13"><p>Definitely not.<a href="#fnref13">↩</a></p></li>
</ol>
</div>

<!-- <?php include_once("analyticstracking.php") ?> -->

<!-- For Google Analytics: -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-88887510-2', 'auto');
  ga('send', 'pageview');

</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
